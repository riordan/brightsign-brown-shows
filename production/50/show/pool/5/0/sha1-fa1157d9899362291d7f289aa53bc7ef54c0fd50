var bsApp=angular.module("bsApp",["ui.bootstrap","ui.router","angular-growl"]);bsApp.constant("snapshotInfoApi","/GetSnapshotConfiguration"),bsApp.constant("snapshotApi","/GetSnapshot?ID="),bsApp.constant("setSnapshotConfigurationApi","/SetSnapshotConfiguration"),bsApp.constant("bsnStatusApi","/bsn/status"),bsApp.constant("bsnOverrideApi","/bsn/override"),bsApp.constant("snapshotRefreshInterval",5e3),bsApp.config(["$stateProvider",function(a){a.state("landing",{url:"/",controller:"landingController",templateUrl:"html/landing/landing.html"}).state("viewSnapshots",{url:"/view-snapshots",controller:"snapshotController",templateUrl:"html/remote-snapshot/view-snapshots.html"}).state("configSnapshots",{url:"/configure-snapshots",controller:"configController",templateUrl:"html/remote-snapshot/configure-snapshots.html"})}]),bsApp.service("bsState",function(){var a={enableRemoteSnapshot:"no",remoteSnapshotInterval:900,remoteSnapshotMaxImages:5,remoteSnapshotJpegQualityLevel:50,remoteSnapshotDisplayPortrait:"false",remoteSnapshotBsnTimeout:300};this.getState=function(){return a},this.setState=function(b){a=b}}),bsApp.service("getSnapshotConfiguration",["$http","bsState","growl","snapshotInfoApi",function(a,b,c,d){this.getData=function(e){var f=b.getState();return a.get(d).success(function(a){var c=new X2JS,d=c.xml_str2json(a);f.enableRemoteSnapshot="true"===d.BrightSignSnapshots._Enabled||"yes"===d.BrightSignSnapshots._Enabled?"yes":"no",f.remoteSnapshotInterval=d.BrightSignSnapshots._Interval?parseInt(d.BrightSignSnapshots._Interval):900,f.remoteSnapshotMaxImages=d.BrightSignSnapshots._MaxImages?parseInt(d.BrightSignSnapshots._MaxImages):5,f.remoteSnapshotJpegQualityLevel=d.BrightSignSnapshots._Quality?parseInt(d.BrightSignSnapshots._Quality):50,f.remoteSnapshotDisplayPortrait=d.BrightSignSnapshots._DisplayPortraitMode,b.setState(f),e(f)}).error(function(){c.addErrorMessage("Error retrieving configuration",{ttl:1e4}),e(f)}),f}}]),bsApp.service("setSnapshotConfiguration",["$http","$state","bsState","growl","setSnapshotConfigurationApi",function(a,b,c,d,e){function f(){var a=[];return angular.forEach(g,function(b,c){a.push(c+"="+b)}),a.join("&")}var g=c.getState();this.execute=function(h,i,j){g.enableRemoteSnapshot=h?"yes":"no",g.remoteSnapshotDisplayPortrait=i?"true":"false",g.remoteSnapshotInterval=60*j,c.setState(g),a.post(e,f(),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(){d.addSuccessMessage("Save succeeded",{ttl:5e3}),b.go("viewSnapshots")}).error(function(){d.addErrorMessage("Error saving configuration")})}}]),bsApp.service("getBsnStatus",["$http","bsState","growl","bsnStatusApi",function(a,b,c,d){this.execute=function(e){var f=b.getState();return a.get(d).success(function(a){var c=new X2JS,d=c.xml_str2json(a);f.bsnActive=d.BrightSignID.bsnActive,f.overrideActive=d.BrightSignID.overrideActive,b.setState(f),e&&e(f)}).error(function(){c.addErrorMessage("Error retrieving configuration",{ttl:1e4}),e&&e(null)}),f}}]),bsApp.service("setBsnOverride",["$http","$state","bsState","growl","bsnOverrideApi",function(a,b,c,d,e){this.execute=function(f){var g=c.getState();c.setState(g),f?(g.remoteSnapshotBsnTimeout=60*f,a.post(e,"timeout="+g.remoteSnapshotBsnTimeout,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(){d.addSuccessMessage("BSN override succeeded",{ttl:5e3})}).error(function(){d.addErrorMessage("Error performing BSN override",{ttl:1e4})})):a.get(e).success(function(){d.addSuccessMessage("Cancel BSN override succeeded",{ttl:5e3}),b.go("viewSnapshots")}).error(function(){d.addErrorMessage("Error on delete override")})}}]),bsApp.controller("landingController",[function(){}]),bsApp.controller("snapshotController",["$http","$interval","$scope","$timeout","$window","getSnapshotConfiguration","$filter","snapshotInfoApi","snapshotApi","snapshotRefreshInterval","growl","getBsnStatus",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(a){var b=c.slides[a],d=e.innerWidth,f=e.innerHeight-112-15-50,g=d/b.actualWidth,h=f/b.actualHeight,i=Math.min(g,h),j=b.actualWidth*i,k=b.actualHeight*i;192>j&&j>0&&(k=Math.floor(192*k/j),j=192),108>k&&k>0&&(j=Math.floor(108*j/k),k=108),b.displayWidth=j,b.displayHeight=k;var l=0==c.rotationAngle||180==c.rotationAngle?1:b.displayHeight/b.displayWidth;b.rotationTransform="rotate("+c.rotationAngle+"deg) scale("+l+")"}function n(b){a.get(h).success(function(a){if(c.processResponse(a),b&&c.slides.length>0){c.slides[c.slides.length-1].active=!0;var d=document.getElementById("snapshot-horizontal");d.scrollLeft=d.scrollWidth}c.snapshotError=!1}).error(function(){c.snapshotError=!0,k.addErrorMessage("Error retrieving snapshots",{ttl:1e4})})}function o(){r&&(b.cancel(r),r=null)}function p(){n(!1)}function q(){o(),r=b(p,j,0,!0),n(!1)}c.snapshotError=!1,c.myInterval=-1,c.slides=[],c.processResponse=function(a){function b(a,b,d){var f=b.replace(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})/,"$1-$2-$3T$4:$5:$6"),h=new Date(f),j=new Date(h.getFullYear(),h.getMonth(),h.getDay(),h.getUTCHours(),h.getUTCMinutes(),h.getUTCSeconds(),h.getUTCMilliseconds()),k=g("date")(j,"M/d/yy h:mm:ss a");if(d>c.slides.length-1){var l=(c.slides.push({ID:a,image:i+a,text:k,active:!1,loading:!0,displayWidth:e.innerWidth,displayHeight:e.innerHeight-112-15-50}),new Image);l.src=i+a,l.addEventListener("load",function(){var b=c.slides[d];b.actualWidth=this.width,b.actualHeight=this.height,m(d),b.image=i+a,b.text=k,b.loading=!1},!1),l=null}else{var n=c.slides[d];n.loading||(n.ID=a,n.image=i+a,n.text=k)}}var d=new X2JS,f=d.xml_str2json(a),h=f.BrightSignSnapshots.Item;"undefined"==typeof h?(c.snapshotError=!0,k.addWarnMessage("No snapshots available",{ttl:1e4})):h.length?angular.forEach(h,function(a,c){b(a.ID,a.Time,c)}):b(h.ID,h.Time,0)};var r=null;c.paused=!1,c.pauseSnapshots=function(){c.paused=!c.paused,c.paused?o():q()},c.rotationAngle=0,c.rotationTransform="rotate(0deg)",c.rotate90=function(){c.rotationAngle=(c.rotationAngle+90)%360,angular.forEach(c.slides,function(a,b){m(b)})},c.snapshotConfig={},f.getData(function(a){c.snapshotConfig=a,"true"===c.snapshotConfig.remoteSnapshotDisplayPortrait&&(c.rotationAngle=90)}),l.execute(function(a){a&&"no"===a.enableRemoteSnapshot&&k.addErrorMessage("Remote Snapshot is disabled. Please visit the Settings page to enable it")}),d(function(){n(!0)}),q(),c.$watch(function(){return e.innerWidth},function(){angular.forEach(c.slides,function(a,b){m(b)})}),c.$watch(function(){return e.innerHeight},function(){angular.forEach(c.slides,function(a,b){m(b)})})}]),bsApp.controller("configController",["$scope","$modal","getSnapshotConfiguration","growl","setSnapshotConfiguration","getBsnStatus","setBsnOverride",function(a,b,c,d,e,f,g){a.remoteSnapshotIntervalMins=15,a.snapshotConfig={},c.getData(function(b){a.snapshotConfig=b,a.bEnableRemoteSnapshot="yes"==a.snapshotConfig.enableRemoteSnapshot,a.bRemoteSnapshotDisplayPortrait="true"==a.snapshotConfig.remoteSnapshotDisplayPortrait,a.remoteSnapshotIntervalMins=a.snapshotConfig.remoteSnapshotInterval/60,a.remoteSnapshotBsnTimeoutMins=a.snapshotConfig.remoteSnapshotBsnTimeout/60}),a.showBsnOverrideDialog=function(){b.open({templateUrl:"bsnOverrideDialog.html",controller:"bsnOverrideController",resolve:{bsn:function(){return{bEnableRemoteSnapshot:a.bEnableRemoteSnapshot,bRemoteSnapshotDisplayPortrait:a.bRemoteSnapshotDisplayPortrait,remoteSnapshotIntervalMins:a.remoteSnapshotIntervalMins,remoteSnapshotBsnTimeoutMins:a.remoteSnapshotBsnTimeoutMins}}}})},a.setSnapshotConfiguration=function(b){return b?void f.execute(function(b){"yes"===b.bsnActive?a.showBsnOverrideDialog():e.execute(a.bEnableRemoteSnapshot,a.bRemoteSnapshotDisplayPortrait,a.remoteSnapshotIntervalMins)}):void d.addErrorMessage("Error saving configuration: please check parameters")},a.cancelBsnOverride=function(){g.execute(null)},f.execute()}]),bsApp.controller("bsnOverrideController",["$modalInstance","$scope","$log","setBsnOverride","setSnapshotConfiguration","bsn",function(a,b,c,d,e,f){b.bsn=f,b.ok=function(b,c){c&&(a.close(),d.execute(b.remoteSnapshotBsnTimeoutMins),e.execute(b.bEnableRemoteSnapshot,b.bRemoteSnapshotDisplayPortrait,b.remoteSnapshotIntervalMins))},b.cancel=function(){a.dismiss("cancel"),c.info("$scope.cancel")}}]);